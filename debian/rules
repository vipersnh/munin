#! /usr/bin/make -f

# export DH_VERBOSE=1

MAKEOPTS = INSTALLDIRS=vendor
LAST_CHANGE=$(shell dpkg-parsechangelog -S Date)
BUILD_DATE=$(shell LC_ALL=C date -u "+%B %d, %Y" -d "$(LAST_CHANGE)")

%:
	dh $@

override_dh_auto_build:
	# ./getversion reads RELEASE if it exists
	dpkg-parsechangelog | sed -n 's/^Version: //p' > RELEASE
	dh_auto_build -- $(MAKEOPTS)
	make -C doc html man SPHINXOPTS="-D today=\"$(BUILD_DATE)\""

override_dh_auto_install:
	dh_auto_install
	rm -rfv debian/tmp/usr/share/man/man1
	mv debian/tmp/etc/munin/munin-node.conf.sample debian/tmp/etc/munin/munin-node.conf
	sed -i -e '/^log_file/clog_file Sys::Syslog' debian/tmp/etc/munin/munin-node.conf
	sed -i -e '/^pid_file/cpid_file /run/munin-node.pid' debian/tmp/etc/munin/munin-node.conf
	mv debian/tmp/etc/munin/munin.conf.sample debian/tmp/etc/munin/munin.conf
	# replace embedded copies of "fonts-materialdesignicons-webfont" with symlinks
	rm debian/tmp/etc/munin/static/css/materialdesignicons.css
	ln -s ../../../../usr/share/fonts-materialdesignicons-webfont/css/materialdesignicons.css \
		debian/tmp/etc/munin/static/css/materialdesignicons.css
	rm -r debian/tmp/etc/munin/static/fonts
	ln -s ../../../../usr/share/fonts-materialdesignicons-webfont/fonts \
		debian/tmp/etc/munin/static/fonts
	# replace embedded copy of "libjs-jquery" with symlink
	rm debian/tmp/etc/munin/static/js/jquery-1.8.3.js
	ln -s ../../../../usr/share/javascript/jquery/jquery.js \
		debian/tmp/etc/munin/static/js/jquery.js
	sed -i 's#/js/jquery-1\.8\.3\.js#/js/jquery.js#' \
		debian/tmp/etc/munin/templates/partial/head.tmpl

override_dh_installinit:
	dh_installinit --package=munin-async
	dh_installinit --package=munin-node
	dh_installinit --name=munin-httpd
	dh_installinit --name=munin-rrdcached
	dh_installinit --name=munin-tmpfiles

override_dh_installsystemd:
	dh_installsystemd --package=munin
	dh_installsystemd --package=munin-async
	dh_installsystemd --package=munin-node
	dh_installsystemd --name=munin-httpd
	dh_installsystemd --name=munin-rrdcached

override_dh_installdocs:
	dh_installdocs --link-doc=munin-common --doc-main-package=munin-common -p munin-doc
	dh_installdocs --link-doc=munin-common --remaining
	@ # Use the packaged javascript libraries
	rm debian/munin-doc/usr/share/doc/munin-common/html/_static/jquery.js; \
	ln -s /usr/share/javascript/jquery/jquery.js \
		debian/munin-doc/usr/share/doc/munin-common/html/_static/jquery.js; \
	rm debian/munin-doc/usr/share/doc/munin-common/html/_static/underscore.js; \
	ln -s /usr/share/javascript/underscore/underscore.js \
		debian/munin-doc/usr/share/doc/munin-common/html/_static/underscore.js; \

override_dh_missing:
	dh_missing --fail-missing
